<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Manage Labs & Rates</title>
    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="/admin_management.css">
</head>
<body>
    <div class="management-container">
        <header class="management-header">
            <h1>Manage Labs & Rates</h1>
            <a href="/admin-dashboard" class="back-link">Back to Dashboard</a>
        </header>

        <!-- Add New Lab Section -->
        <section class="section">
            <h2>Add New Lab</h2>
            <form action="/admin/labs/add" method="POST">
                <div class="form-grid" style="grid-template-columns: 2fr 1fr;">
                    <div>
                        <label for="name">Lab Name</label>
                        <input type="text" id="name" name="name" required placeholder="e.g., Apollo Diagnostics, Dr. Lal PathLabs">
                    </div>
                    <div style="align-self: end;">
                        <button type="submit" style="margin-top: 0;">Create Lab</button>
                    </div>
                </div>
            </form>
        </section>

        <!-- Existing Labs Section -->
        <section class="section">
            <h2>Existing Labs</h2>
            <p style="font-size: 0.9em; color: #555;">
                Manage labs, upload their logos, and assign rate databases (Package Lists). Manage package lists <a href="/admin/package-lists">here</a>.
            </p>

            <table class="data-table">
                <thead>
                    <tr>
                        <th style="width: 25%;">Lab</th>
                        <th style="width: 35%;">Assigned Rate Databases</th>
                        <th style="width: 40%;">Upload Logo (JPEG/PNG)</th>
                    </tr>
                </thead>
                <tbody>
                <% if (labs.length > 0) { %>
                    <% labs.forEach(lab => { %>
                        <tr>
                            <td>
                                <div class="lab-info">
                                    <strong><%= lab.name %></strong>
                                    <% if (lab.logo_path) { %>
                                        <img src="<%= lab.logo_path %>?v=<%= new Date().getTime() %>" alt="Logo">
                                    <% } else { %>
                                        <small>No logo uploaded</small>
                                    <% } %>
                                </div>
                            </td>
                            <td>
                                <form action="/admin/labs/update-lists" method="POST" class="in-table-form">
                                    <input type="hidden" name="lab_id" value="<%= lab.id %>">
                                    <label for="lists_<%= lab.id %>">Assign one or more rate lists:</label>
                                    <select name="package_list_ids" id="lists_<%= lab.id %>" multiple size="4">
                                        <% allLists.forEach(list => { %>
                                            <option value="<%= list.id %>" <%= lab.assigned_list_ids.has(list.id) ? 'selected' : '' %>>
                                                <%= list.name %>
                                            </option>
                                        <% }) %>
                                    </select>
                                    <small>Hold Ctrl/Cmd to select multiple.</small>
                                    <button type="submit" class="action-btn" style="background-color: #007bff;">Save Assignments</button>
                               </form>
                           </td>
                           <td>
                               <form action="/admin/labs/upload-logo" method="POST" enctype="multipart/form-data" class="in-table-form" onsubmit="this.querySelector('button').innerText = 'Uploading...'">
                                    <input type="hidden" name="lab_id" value="<%= lab.id %>">
                                    <label>Upload or replace logo:</label>
                                    <div class="file-upload-container">
                                        <label for="logo_<%= lab.id %>" class="file-upload-label">Choose File</label>
                                        <span class="file-name-display">No file selected</span>
                                        <input type="file" name="logo_file" id="logo_<%= lab.id %>" accept="image/jpeg, image/png" required onchange="this.parentElement.querySelector('.file-name-display').textContent = this.files[0] ? this.files[0].name : 'No file selected';">
                                    </div>
                                    <button type="submit" class="action-btn" style="background-color: #28a745;">Upload</button>
                                </form>
                            </td>
                        </tr>
                    <% }) %>
                <% } else { %>
                    <tr>
                        <td colspan="3" style="text-align: center;">No labs found. Create one above.</td>
                    </tr>
                <% } %>
            </tbody>
            </table>
        </section>
    </div>
</body>
</html>
